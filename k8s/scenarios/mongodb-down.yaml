# =============================================================================
# SCENARIO 9: MongoDB Down - Cascading Dependency Failure
# =============================================================================
# This scenario scales MongoDB to 0 replicas, simulating a database outage.
# Since makeline-service depends on MongoDB for order storage, it will start
# failing health checks and become unavailable. Orders can still be placed
# (they queue in RabbitMQ) but are never fulfilled.
#
# This is the most realistic scenario because it requires SRE Agent to trace
# the dependency chain: makeline-service → MongoDB → scaled to 0.
#
# SRE Agent can diagnose: Dependency failures, cascading impact, service
# health correlation, and recommend scaling MongoDB back up.
#
# HOW TO BREAK:
# kubectl apply -f k8s/scenarios/mongodb-down.yaml
#
# HOW TO FIX:
# kubectl apply -f k8s/base/application.yaml
# =============================================================================
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb
  namespace: pets
  labels:
    app: mongodb
    scenario: mongodb-down
    sre-demo: breakable
spec:
  # BREAKING CHANGE: Scale to 0 replicas - database goes offline
  replicas: 0
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
        scenario: mongodb-down
    spec:
      nodeSelector:
        nodepool-type: user
      containers:
        - name: mongodb
          image: mongo:4.4
          ports:
            - containerPort: 27017
          resources:
            requests:
              memory: "256Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          volumeMounts:
            - name: mongodb-data
              mountPath: /data/db
      volumes:
        - name: mongodb-data
          persistentVolumeClaim:
            claimName: mongodb-data-pvc
